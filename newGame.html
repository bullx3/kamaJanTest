<!DOCTYPE html>
<html>
<head>
	<title>コン蒲麻雀倶楽部</title>
	<meta charset="UTF-8">
	<style>
		body {
			font-size: 2.0em;
			font-family: 'Avenir','Helvetica Neue','Helvetica','Arial','Hiragino Sans','ヒラギノ角ゴシック',YuGothic,'Yu Gothic','メイリオ', Meiryo,'ＭＳ Ｐゴシック','MS PGothic'
		}

		.tableTaikyokuNow {
			text-align: center;
			border-collapse: collapse; /* 一重線 */
			width: 100%;
			border: 2px solid gray;
		}

		.tableTaikyokuNow th {
			border: 1px solid gray;
			padding-top: 1.0em;
			padding-bottom: 1.0em;
		}

		.thName {
			background: #dcdcdc;
		}

		.thSum {
			background: lightgreen;
		}


		.tableTaikyokuNow td {

			border: 1px solid gray;
			padding-top: 1.0em;
			padding-bottom: 1.0em;
		}
		.tableTaikyokuNow td:nth-child(2n){
			background-color: lightblue;
		}


		.tableTaikyokuNow caption {
			caption-side: top;
			font-size: x-large;
			font-weight: bold;
			text-align: left;
		}

		.sqr_button {
			font-size: 1.0em;
			display: inline-block;
			padding: 0.5em 0.5em;
			text-decoration: none;
			background: #668ad8;/*ボタン色*/
			color: #FFF;
			border-bottom: solid 4px #627295;
			border-radius: 3px;
		}


		#inputDialog {
		    width: 90%;
		    margin: auto;
		    margin-top: 10vh;
		    padding: 30px 20px;
		    display: none;
		    text-align: center;
		    border: 1px solid #aaa;
		    box-shadow: 2px 2px 4px #888;
		}

		ul li {
			list-style: none;
			label {
			    margin-right: 10px;
			    width: 100px;
			    float: left;
			}
		}

		.invisibleBtn {
			background: none;
			border: none;
			font-size: 1.0em;

		}

	</style>
</head>
<body>

<div id="showScore">
<table>
	<tr>
		<td>対局開始時刻</td>
		<td>2018/5/16 22:30</td>
		<td><Button class = "sqr_button">メンバー編集</Button></td>
		<td><button id = "addbtn" class = "sqr_button" >追加</button></td>
	</tr>

</table>


<table id = "table_id" class = "tableTaikyokuNow">
<caption>対局中！！</caption>
	<tr class="thName">	
		<th width = 12%>種類</th>
		<th width = 18%>トム</th>
		<th width = 18%>あきら</th>
		<th width = 18%>車掌</th>
		<th width = 18%>たいち</th>
		<th width = 18%>どもん</th>
	</tr>
	<tr class="thSum">
		<th>合計</th>
		<th></th>
		<th></th>
		<th></th>
		<th></th>
		<th></th>
	</tr>
	<tr>
		<td>四麻</td>
		<td>50</td>
		<td>-42</td>
		<td>18</td>
		<td>-16</td>
		<td></td>
	</tr>
	<tr>
		<td>四麻</td>
		<td>9</td>
		<td>49</td>
		<td>-40</td>
		<td></td>
		<td>-50</td>
	</tr>
	<tr>
		<td>チップ</td>
		<td>10</td>
		<td>-8</td>
		<td>8</td>
		<td>-6</td>
		<td>-6</td>
	</tr>

	<tr>
		<td></td><td></td><td></td>
		<td></td><td></td><td></td>
	</tr>
	<tr>
		<td></td><td></td><td></td>
		<td></td><td></td><td></td>
	</tr>
	<tr>
		<td></td><td></td><td></td>
		<td></td><td></td><td></td>
	</tr>
	<tr>
		<td></td><td></td><td></td>
		<td></td><td></td><td></td>
	</tr>

</table>

<button class = "sqr_button">ゲーム終了</button>
</div> <!-- showScore-->



<div id="inputDialog">
    <p>
	<input id="kind4ma" type="radio" name="kind" value="4ma">
	<label for="kind4ma">四麻</label>
	<input id="kind3ma" type="radio" name="kind" value="3ma">
	<label for="kind3ma">三麻</label>
	<input id="kindChip" type="radio" name="kind" value="chip">
	<label for="kindChip">チップ</label>
	</p>

	<table id="inputScore">
	</table>

	<p>合計  <span id="inScoreSum">0</span></p>


	<p>よろしいですか？</p>
    <button id="yes" class = "sqr_button">はい</button>
    <button id="cancel" class = "sqr_button">キャンセル</button>
</div>


<script>
	const firstRow = 2; // 点数入力の初期行(0から開始)
	const firstCol = 1; // 点数入力の初期列(0から開始)
	const sumRow = 1;	// 合計値の初期列
	var flg = 0; // 入力値判定フラグ
	var backupText = "";
	var inputMode = 0; //0:通常 1:編集中

	window.onload = function() {

		var myTbl = document.getElementById('table_id');
		var tdList = myTbl.getElementsByTagName('td');
		for(var cnt=0; cnt < tdList.length; cnt++){
			tdList[cnt].setAttribute('id','td' + cnt);	
			tdList[cnt].onclick = function() {
				console.log("log:onClick " + this.innerHTML);

				if(flg==1){return;}

				backupText = this.innerHTML;// 入力されなかった時用のバックアップ
				console.log("log:backupText " + backupText);

//				editTd(this.id);
				


				displayDialog(myTbl, this.id);

				return;
			}
		}

		console.log("onload calc");
		calcSum(myTbl);


		// 編集可能領域がクリックされた場合
		function editTd(id) {
			console.log("log:edit " + id)
			var tdList = document.getElementsByTagName('td');
			var spn = document.createElement('span');
			spn.setAttribute('contenteditable','true')
			spn.setAttribute('id','spn' + id);

			tdList[id].innerHTML = ""; // 既存部分は編集できない？
			tdList[id].appendChild(spn);
			spn.focus();
			spn.onblur = function() {
				blurTd(id);
			}
		} // end of editTd

			// フォーカスアウト
		function blurTd(id) {

			console.log("log:blurTd " + id)
			var spn = document.getElementById('spn' + id);
			console.log(spn);
			var str = spn.textContent; //textContextだと改行が取得できなかった(br変換されてた(chrome))。innnerTextだと改行ありで取得
			// 入力値チェック

			if(str.match(/[^0-9 . -]|[¥s]+/)) {
				console.log("log:input invalid text " + str);
				flg = 1;

				alert("半角数値を入れてください")
				editTd(id);
			}else if(str == ""){
				console.log("log:input none " + backupText);

				flg = 0;
				// 入力がなかったので戻す
				tdList[id].innerHTML = backupText;
			}else {
				// 数値が変更された
				console.log("log:input text " + str);
				flg = 0;
				tdList[id].innerHTML = str;
				calcSum(myTbl)
			}

		} //End of blurTd

		function calcSum(tbl){

			var rowLen = tbl.rows.length; // 行数
			var colLen = tbl.rows[firstRow].cells.length; // 列数
			var sum = [colLen - firstCol];
			console.log("log:row=" + rowLen + " col="+colLen);
			for(var colCnt = firstCol;colCnt < colLen ; colCnt++){
				sum[colCnt-1] = 0;

				for(var rowCnt = firstRow;rowCnt < rowLen; rowCnt++){

					num = myTbl.rows[rowCnt].cells[colCnt].textContent;
					num = parseInt(num);
//					console.log("log:table[%d][%d]=%d",rowCnt,colCnt,num);
					if (isNaN(num)){
						// 整数以外は処理しない
						console.log("log: NaN")
						continue;
					}
					sum[colCnt-firstCol] += num
				}

				// 合計値を書き換え
				var sumCell = tbl.rows[sumRow].cells[colCnt];
				sumCell.innerHTML = sum[colCnt - firstCol];

			}
			console.log("log:sum "+ sum);
		} // End of calcSum


		// 行の合計が0になっているかどうかを確認(boolean)
		function checkLine(tbl , rowNo){
			var sum = 0;
			var colLen = tbl.rows[1].cells.length; // 列数
			for(var cnt = firstCol; cnt < colLen; cnt++){
					num = myTbl.rows[rowCnt].cells[colCnt].textContent;
					num = parseInt(num);
					if (isNaN(num)){
						// 整数以外は処理しない
						console.log("log: NaN")
						continue;
					}
				sum += num;
			}



		}
	} // End of window.onload


	var addbtn = document.getElementById("addbtn");
	addbtn.addEventListener("click", function(){

		var tbl = document.getElementById("table_id");
		var rowLen = tbl.rows.Length;
		console.log("log:rowLen=" + rowLen);
		var tr = tbl.insertRow(4);
		var td1 = tr.insertCell(-1);
		td1.innerHTML = ""
		var td2 = tr.insertCell(-1);
		td2.innerHTML = ""
		var td3 = tr.insertCell(-1);
		var td4 = tr.insertCell(-1);
		var td5 = tr.insertCell(-1);
		var td6 = tr.insertCell(-1);

		// rubyに入力を送信

		// 合計も変更
	}, false);



// このリストはrubyで自動生成する
const plist = {1:'トム', 2:'クニ', 3:'まーさん',4:'あきら', 6:'車掌',8:'どもん', 9:'のり', 10:'たいち'};
const players = [1, 4, 6, 10, 8];

console.log(plist);
console.log(players);

var inScoreTbl = document.getElementById('inputScore');
var inputObjs = [];

var inRowCnt = 0;

players.forEach(function(playerNo){
	var tr = inScoreTbl.insertRow(inRowCnt);
	var td1 = tr.insertCell(-1);
	td1.innerHTML = plist[playerNo];
	var td2 = tr.insertCell(-1);
	var doc = document.createElement("input");
	doc.type = "number"
	doc.id = "inputId" + playerNo;
	doc.name = "input" + playerNo;
	td2.appendChild(doc);
	inputObjs.push(doc);
	// テキストボックスの入力イベント
	doc.addEventListener("input",function(){
		console.log("event input:" + this.value);
		calcInputScore();
	});
	inRowCnt++;
})
console.log(inputObjs);

var inScoreSumObj = document.getElementById('inScoreSum');

function calcInputScore(){

	var sum = 0;

	inputObjs.forEach(function(obj){
		value = obj.value;
//		console.log("value:" + value);
		num = parseInt(value)
		if (!isNaN(num)){
			sum += num;
		}

	});
	console.log("sum:" + sum);
	
	inScoreSumObj.innerHTML = "";
	inScoreSumObj.textContent = sum;
	if(sum < 0){
		inScoreSumObj.style.color = "red";
	} else{
		inScoreSumObj.style.color = "black";
	}

}

//function show


//各種ボタン要素を取得しておく
var inputDialogObj = document.getElementById('inputDialog');
//var btn = document.getElementById('btn');
var yes = document.getElementById('yes');
var cancel = document.getElementById('cancel');
 
var showScoreObj = document.getElementById('showScore');

var editGameNo = 0;


function displayDialog(scoreTbl, tdId){
	console.log(tdId);
	id = tdId.substr(2);
	idNum = parseInt(id);
	console.log(id);

	var colLen = scoreTbl.rows[1].cells.length; // 列数

	editGameNo = Math.floor(idNum / colLen);
	console.log("editGameNo1:" + editGameNo);

	for(var cnt = 0; cnt < colLen; cnt++){;

		var num = (editGameNo * (players.length + firstCol )) + cnt;
		var strId = 'td' + num;
		var tdObj = document.getElementById(strId);
		if(cnt != 0){
			inputObj = inputObjs[cnt-1];
			inputObj.value = tdObj.textContent;
		}else{
			// とりあえずクリア
			radioObjs = document.getElementsByName("kind");
			radioObjs.forEach(function(obj){
				obj.checked = false;
			})

			// 0 は種類なのでradioボタン設置
			var kind = tdObj.textContent;
			var kindId = ''
			switch(kind){
			case '四麻':
				kindId = 'kind4ma';
				break;
			case '三麻':
				kindId = 'kind3ma';
				break;
			case 'チップ':
				kindId = 'kindChip';
				break;
			}
			if(kindId != ''){
				console.log("kindId:" + kindId)
				radioObj = document.getElementById(kindId);
				radioObj.checked = true
			}
		}
	} // for


    inputDialogObj.style.display = 'block';
    showScoreObj.style.display = 'none';
} // function displayDialog
 
//「はい」がクリックされたら
yes.addEventListener('click', function(){ 
	console.log('yes');

	sum = inScoreSumObj.textContent;
	if(sum != 0){
		// 合計が0以外なのでアラート表示
		// 何も入力してない場合もアラートにしよう
		alert("合計を0にして下さい")
		return;
	}else{
		console.log("editGameNo2:" + editGameNo)

		// todo
		// 本来ここで種類を入れるが無理やり四麻を入れる
		var num = editGameNo * (players.length + firstCol );
		console.log("tdNo:" + num)
		tdObj = document.getElementById('td' + num);
		tdObj.innerText = "四麻"

		var cnt = 1;
		inputObjs.forEach(function(obj){
			tdNo = editGameNo * (players.length +firstCol)+ cnt;
			console.log("tdNo:" + tdNo)
			tdObj = document.getElementById('td' + tdNo);
			console.log(tdObj.textContent)
			console.log(obj.value);
			tdObj.innerText = String(obj.value);
			cnt++;
		})
	    inputDialogObj.style.display = 'none';
	    showScoreObj.style.display = 'block';

	    // ネットワークに送信
	}


});
 

//「キャンセル」がクリックされたら
cancel.addEventListener('click', function(){
	console.log('cancel');
    inputDialogObj.style.display = 'none';
    showScoreObj.style.display = 'block';
 });


</script>



</body>
</html>
